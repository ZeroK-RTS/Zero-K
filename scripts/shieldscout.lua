include 'constants.lua'
include "JumpRetreat.lua"

local pelvis = piece 'pelvis'
local pole = piece 'pole'
local aimpitch = piece 'aimpitch'
local aimyaw = piece 'aimyaw'
local lthigh, lcalf, lfoot = piece('lthigh', 'lcalf', 'lfoot')
local rthigh, rcalf, rfoot = piece('rthigh', 'rcalf', 'rfoot')
local leftLeg = { thigh = piece'lthigh', calf = piece'lcalf', foot = piece'lfoot'}
local rightLeg = { thigh = piece'rthigh', calf = piece'rcalf', foot = piece'rfoot'}
local base = piece 'base'
local box = piece 'box'

local smokePiece = { box }

local ANIM_FRAMES = 4

-- signals
local SIG_WALK = 1
local SIG_AIM = 2
local SIG_RESTORE = 4

--[[ messy but does tell you how spin works
local function SpinScienceThread()
	local startSpinTime = Spring.GetGameFrame()
	
	local startFrame = Spring.GetGameFrame()
	Turn(pelvis, y_axis, 0)
	Spin(pelvis, y_axis, math.rad(1000000), math.rad(1))
	
	while true do
		Sleep(30)
		local frame = Spring.GetGameFrame()
		--Spring.Echo(frame - startFrame)
		local x,y,z = Spring.UnitScript.GetPieceRotation(pelvis)
		Spring.Echo(y)
	end
end
--]]

local walking = false -- prevent script.StartMoving from spamming threads if already walking
local doingSomersault = false

-----------------------------
-- Jumping

local function jumpTuckInLegs(leg)
	Turn(leg.thigh, x_axis, math.rad(-120), math.rad(100))
	Turn(leg.calf, x_axis, math.rad(-10), math.rad(100))
	Turn(leg.foot, x_axis, math.rad(-20), math.rad(100))
end

local function jumpUnTuckLegs(leg)
	Turn(leg.thigh, x_axis, 0, math.rad(200))
	Turn(leg.calf, x_axis, 0, math.rad(200))
	Turn(leg.foot, x_axis, 0, math.rad(200))
end

local function somersaultThread(jumpDuration)
	Turn(pelvis, x_axis, 0)
	Sleep(jumpDuration/4)

	jumpTuckInLegs(leftLeg)
	jumpTuckInLegs(rightLeg)
	
	local speed = 4*math.pi/(9/16*jumpDuration/1000)
	local accel = speed*(16/6)/(jumpDuration/1000)/30
	
	Spin(pelvis, x_axis, speed, accel)
	
	Sleep(jumpDuration/2)
	
	jumpUnTuckLegs(leftLeg)
	jumpUnTuckLegs(rightLeg)
end

local function jumpLegLaunch(leg)
	Signal(SIG_WALK)
	Turn(leg.thigh, x_axis, 0)
	Turn(leg.calf, x_axis, 0)
	Turn(leg.foot, x_axis, math.rad(-40))
	
	Turn(leg.thigh, x_axis, math.rad(-30), math.rad(100))
	Turn(leg.calf, x_axis, math.rad(60), math.rad(500))
	Turn(leg.foot, x_axis, math.rad(-10), math.rad(600))
end

local function jumpLegLand(leg)
	Turn(leg.thigh, x_axis, 0, math.rad(100))
	Turn(leg.calf, x_axis, math.rad(-30), math.rad(300))
	Turn(leg.foot, x_axis, math.rad(10), math.rad(100))
end

function beginJump(turn,lineDist,flightDist,duration)
	Turn(box, x_axis, math.rad(20))
	jumpLegLaunch(leftLeg)
	jumpLegLaunch(rightLeg)
	Turn(box, x_axis, 0, math.rad(150))
	
	doingSomersault = math.random() < 0.15
	
	if doingSomersault and not GG.lodLevelMedium then
		StartThread(somersaultThread, duration*GG.Script.frameToMs)
	end
end

function halfJump()
	if not doingSomersault then
		script.StopMoving()
	end
end

function endJump()
	Spring.UnitScript.StopSpin(pelvis, x_axis)
	Turn(pelvis, x_axis, 0)
	Turn(box, x_axis, math.rad(40),math.rad(400))
	Move(pelvis, y_axis, -8, 80)
	jumpLegLand(leftLeg)
	jumpLegLand(rightLeg)
end

-----------------------------
-- Walking low detail

local function Step(front, back)
	Turn(front.thigh, x_axis, math.rad(70), math.rad(230))
	Turn(front.calf, x_axis, math.rad(20), math.rad(270))
	--Turn(front.foot, x_axis, math.rad(-100), math.rad(420))
	
	Turn(back.thigh, x_axis, math.rad(-20), math.rad(420))
	Turn(back.calf, x_axis, math.rad(50), math.rad(420))
	--Turn(back.foot, x_axis, math.rad(30), math.rad(420))
	
	--Turn(pelvis, z_axis, math.rad(-5), math.rad(40))
	Turn(front.thigh, z_axis, math.rad(5), math.rad(40))
	Turn(front.thigh, z_axis, math.rad(5), math.rad(40))
	--Move(pelvis, y_axis, 0.7, 8000)
	
	--WaitForTurn(front.thigh, x_axis)
	Sleep(166)
	
	Turn(front.thigh, x_axis, math.rad(-10), math.rad(320))
	Turn(front.calf, x_axis, math.rad(-60), math.rad(500))
	--Turn(front.foot, x_axis, math.rad(70), math.rad(270))
	
	Turn(back.thigh, x_axis, math.rad(40), math.rad(270))
	Turn(back.calf, x_axis, math.rad(-40), math.rad(270))
	--Turn(back.foot, x_axis, 0, math.rad(270))
	
	--Move(pelvis, y_axis, 0, 8000)
	Turn(box, x_axis, math.rad(10), math.rad(40))
	
	--WaitForTurn(front.calf, x_axis)
	Sleep(166)
	
	Turn(box, x_axis, math.rad(-10), math.rad(40))
end

local function WalkLowDetail()
	Signal(SIG_WALK)
	SetSignalMask(SIG_WALK)
	
	while true do
		Step(leftLeg, rightLeg)
		Step(rightLeg, leftLeg)
	end
end

-----------------------------
-- Walking

-- this section generated by Zero-K-Artwork/blender_animations/dirtbag.blend

local function Walk()
	Signal(SIG_WALK)
	SetSignalMask(SIG_WALK)
	local speedMult, sleepTime = GG.Script.GetSpeedParams(unitID, ANIM_FRAMES)

	-- Frame: 4 (first step)
	Turn(box, z_axis, 0.021002, 0.630061 * speedMult) -- delta=1.20
	Turn(box, y_axis, 0.199328, 5.979846 * speedMult) -- delta=11.42
	Turn(lcalf, x_axis, -0.026425, 0.582167 * speedMult) -- delta=1.11
	Turn(lcalf, z_axis, -0.000000, 0.375469 * speedMult) -- delta=-0.72
	Turn(lcalf, y_axis, -0.000000, 3.295964 * speedMult) -- delta=-6.29
	Turn(lfoot, x_axis, 1.042979, 29.269858 * speedMult) -- delta=-55.90
	Turn(lfoot, z_axis, -0.000000, 0.350549 * speedMult) -- delta=0.67
	Turn(lfoot, y_axis, 0.000000, 2.952167 * speedMult) -- delta=-5.64
	Turn(lthigh, x_axis, -1.746536, 50.716580 * speedMult) -- delta=96.86
	Turn(lthigh, z_axis, 0.000000, 0.496398 * speedMult) -- delta=-0.95
	Turn(lthigh, y_axis, 0.000000, 2.901948 * speedMult) -- delta=-5.54
	Turn(rcalf, x_axis, 0.550489, 12.260745 * speedMult) -- delta=-23.42
	Turn(rfoot, x_axis, -0.904162, 25.533221 * speedMult) -- delta=48.76
	Turn(rthigh, x_axis, 0.636317, 21.751793 * speedMult) -- delta=-41.54
	Sleep(sleepTime)

	while true do
		speedMult, sleepTime = GG.Script.GetSpeedParams(unitID, ANIM_FRAMES)
		-- Frame:8
		Turn(box, z_axis, -0.097761, 3.562895 * speedMult) -- delta=-6.80
		Turn(box, y_axis, 0.160783, 1.156350 * speedMult) -- delta=-2.21
		Turn(lcalf, x_axis, 0.273907, 9.009969 * speedMult) -- delta=-17.21
		Turn(lfoot, x_axis, 0.549896, 14.792483 * speedMult) -- delta=28.25
		Turn(lthigh, x_axis, -0.823804, 27.681956 * speedMult) -- delta=-52.87
		Turn(rcalf, x_axis, 0.907244, 10.702652 * speedMult) -- delta=-20.44
		Turn(rfoot, x_axis, -1.036089, 3.957801 * speedMult) -- delta=7.56
		Turn(rthigh, x_axis, 0.822463, 5.584391 * speedMult) -- delta=-10.67
		Sleep(sleepTime)
		-- Frame:12
		Move(base, y_axis, -3.394583, 101.837497 * speedMult) -- delta=-3.39
		Move(base, z_axis, 4.023210, 120.696301 * speedMult) -- delta=4.02
		Turn(box, x_axis, 0.209935, 6.298051 * speedMult) -- delta=-12.03
		Turn(box, z_axis, -0.106723, 0.268844 * speedMult) -- delta=-0.51
		Turn(box, y_axis, 0.082553, 2.346910 * speedMult) -- delta=-4.48
		Turn(lcalf, x_axis, -0.561434, 25.060244 * speedMult) -- delta=47.86
		Turn(lfoot, x_axis, 0.352994, 5.907058 * speedMult) -- delta=11.28
		Turn(lthigh, x_axis, 0.208440, 30.967303 * speedMult) -- delta=-59.14
		Move(pelvis, y_axis, -3.394583, 101.837497 * speedMult) -- delta=-3.39
		Turn(rcalf, x_axis, -0.582191, 44.683072 * speedMult) -- delta=85.34
		Turn(rfoot, x_axis, -0.516490, 15.587946 * speedMult) -- delta=-29.77
		Turn(rthigh, x_axis, 0.741984, 2.414371 * speedMult) -- delta=4.61
		Sleep(sleepTime)
		-- Frame:16
		Move(base, y_axis, -2.011605, 41.489346 * speedMult) -- delta=1.38
		Move(base, z_axis, 2.765957, 37.717588 * speedMult) -- delta=-1.26
		Turn(box, x_axis, -0.000000, 6.298051 * speedMult) -- delta=12.03
		Turn(box, z_axis, -0.042004, 1.941557 * speedMult) -- delta=3.71
		Turn(box, y_axis, -0.093780, 5.289995 * speedMult) -- delta=-10.10
		Turn(lcalf, x_axis, -0.025841, 16.067800 * speedMult) -- delta=-30.69
		Turn(lfoot, x_axis, -0.601849, 28.645303 * speedMult) -- delta=54.71
		Turn(lthigh, x_axis, 0.613704, 12.157915 * speedMult) -- delta=-23.22
		Move(pelvis, y_axis, -2.011605, 41.489346 * speedMult) -- delta=1.38
		Turn(rcalf, x_axis, -0.443152, 4.171171 * speedMult) -- delta=-7.97
		Turn(rfoot, x_axis, 0.326250, 25.282224 * speedMult) -- delta=-48.29
		Turn(rthigh, x_axis, -0.698913, 43.226920 * speedMult) -- delta=82.56
		Sleep(sleepTime)
		-- Frame:20
		Move(base, y_axis, 0.000000, 60.348151 * speedMult) -- delta=2.01
		Move(base, z_axis, 0.000000, 82.978714 * speedMult) -- delta=-2.77
		Turn(box, z_axis, -0.021002, 0.630061 * speedMult) -- delta=1.20
		Turn(box, y_axis, -0.199328, 3.166438 * speedMult) -- delta=-6.05
		Turn(lcalf, x_axis, 0.380388, 12.186861 * speedMult) -- delta=-23.28
		Turn(lfoot, x_axis, -0.819673, 6.534705 * speedMult) -- delta=12.48
		Turn(lthigh, x_axis, 0.721914, 3.246306 * speedMult) -- delta=-6.20
		Move(pelvis, y_axis, 0.000000, 60.348151 * speedMult) -- delta=2.01
		Turn(rcalf, x_axis, 0.100335, 16.304607 * speedMult) -- delta=-31.14
		Turn(rfoot, x_axis, 0.991725, 19.964244 * speedMult) -- delta=-38.13
		Turn(rthigh, x_axis, -1.822034, 33.693615 * speedMult) -- delta=64.35
		Sleep(sleepTime)
		-- Frame:24
		
		speedMult, sleepTime = GG.Script.GetSpeedParams(unitID, ANIM_FRAMES)
		
		Turn(box, z_axis, 0.000000, 0.630061 * speedMult) -- delta=1.20
		Turn(box, y_axis, -0.212747, 0.402554 * speedMult) -- delta=-0.77
		Turn(lcalf, x_axis, 0.702116, 9.651839 * speedMult) -- delta=-18.43
		Turn(lfoot, x_axis, -0.967088, 4.422462 * speedMult) -- delta=8.45
		Turn(lthigh, x_axis, 0.920608, 5.960838 * speedMult) -- delta=-11.38
		Turn(rcalf, x_axis, 0.437625, 10.118726 * speedMult) -- delta=-19.33
		Turn(rfoot, x_axis, 0.464414, 15.819334 * speedMult) -- delta=30.21
		Turn(rthigh, x_axis, -0.902040, 27.599829 * speedMult) -- delta=-52.71
		Sleep(sleepTime)
		-- Frame:28
		Move(base, y_axis, -4.148935, 124.468060 * speedMult) -- delta=-4.15
		Move(base, z_axis, 3.520309, 105.609269 * speedMult) -- delta=3.52
		Turn(box, x_axis, 0.195870, 5.876096 * speedMult) -- delta=-11.22
		Turn(box, z_axis, 0.111003, 3.330094 * speedMult) -- delta=6.36
		Turn(box, y_axis, -0.083776, 3.869126 * speedMult) -- delta=7.39
		Turn(lcalf, x_axis, -0.604167, 39.188474 * speedMult) -- delta=74.84
		Turn(lfoot, x_axis, -0.908034, 1.771610 * speedMult) -- delta=-3.38
		Turn(lthigh, x_axis, 1.311789, 11.735423 * speedMult) -- delta=-22.41
		Move(pelvis, y_axis, -4.148935, 124.468060 * speedMult) -- delta=-4.15
		Turn(rcalf, x_axis, -0.587436, 30.751836 * speedMult) -- delta=58.73
		Turn(rfoot, x_axis, 0.558883, 2.834063 * speedMult) -- delta=-5.41
		Turn(rthigh, x_axis, 0.028553, 27.917776 * speedMult) -- delta=-53.32
		Sleep(sleepTime)
		-- Frame:32
		Move(base, y_axis, -2.137330, 60.348151 * speedMult) -- delta=2.01
		Move(base, z_axis, 2.011605, 45.261118 * speedMult) -- delta=-1.51
		Turn(box, x_axis, -0.000000, 5.876096 * speedMult) -- delta=11.22
		Turn(box, z_axis, 0.044837, 1.984982 * speedMult) -- delta=-3.79
		Turn(box, y_axis, 0.000000, 2.513274 * speedMult) -- delta=4.80
		Turn(lcalf, x_axis, -0.527642, 2.295724 * speedMult) -- delta=-4.38
		Turn(lfoot, x_axis, 0.362488, 38.115686 * speedMult) -- delta=-72.80
		Turn(lthigh, x_axis, -0.647833, 58.788675 * speedMult) -- delta=112.28
		Move(pelvis, y_axis, -2.137330, 60.348151 * speedMult) -- delta=2.01
		Turn(rcalf, x_axis, 0.047994, 19.062881 * speedMult) -- delta=-36.41
		Turn(rfoot, x_axis, -0.579330, 34.146377 * speedMult) -- delta=65.21
		Turn(rthigh, x_axis, 0.517353, 14.664016 * speedMult) -- delta=-28.01
		Sleep(sleepTime)
		-- Frame:36
		Move(base, y_axis, 0.000000, 64.119909 * speedMult) -- delta=2.14
		Move(base, z_axis, 0.000000, 60.348151 * speedMult) -- delta=-2.01
		Turn(box, z_axis, 0.021002, 0.715051 * speedMult) -- delta=-1.37
		Turn(box, y_axis, 0.199328, 5.979846 * speedMult) -- delta=11.42
		Turn(lcalf, x_axis, -0.026425, 15.036524 * speedMult) -- delta=-28.72
		Turn(lfoot, x_axis, 1.042979, 20.414716 * speedMult) -- delta=-38.99
		Turn(lthigh, x_axis, -1.746536, 32.961066 * speedMult) -- delta=62.95
		Move(pelvis, y_axis, 0.000000, 64.119909 * speedMult) -- delta=2.14
		Turn(rcalf, x_axis, 0.550489, 15.074870 * speedMult) -- delta=-28.79
		Turn(rfoot, x_axis, -0.904162, 9.744964 * speedMult) -- delta=18.61
		Turn(rthigh, x_axis, 0.636317, 3.568894 * speedMult) -- delta=-6.82
		Sleep(sleepTime)
	end
end

local function StopWalking()
	Signal(SIG_WALK)
	SetSignalMask(SIG_WALK)

	local speedMult = 0.5 * GG.Script.GetSpeedParams(unitID, ANIM_FRAMES) -- slower restore speed for last step

	Move(base, y_axis, 0.000000, 311.170149 * speedMult)
	Move(base, z_axis, 0.000000, 301.740754 * speedMult)
	Move(pelvis, y_axis, 0.000000, 311.170149 * speedMult)
	Move(rfoot, y_axis, 1.587693, -13.230773 * speedMult)
	Move(rfoot, z_axis, -0.339331, -2.827761 * speedMult)
	Turn(box, x_axis, 0.000000, 15.745128 * speedMult)
	Turn(box, y_axis, 0.000000, 14.949616 * speedMult)
	Turn(box, z_axis, 0.000000, 8.907239 * speedMult)
	Turn(lcalf, x_axis, -0.007019, 97.971185 * speedMult)
	Turn(lcalf, y_axis, 0.109865, 8.239910 * speedMult)
	Turn(lcalf, z_axis, 0.012516, 0.938673 * speedMult)
	Turn(lfoot, x_axis, 0.067317, 95.289215 * speedMult)
	Turn(lfoot, y_axis, 0.098406, 7.380418 * speedMult)
	Turn(lfoot, z_axis, -0.011685, 0.876372 * speedMult)
	Turn(lthigh, x_axis, -0.055983, 146.971688 * speedMult)
	Turn(lthigh, y_axis, 0.096732, 7.254870 * speedMult)
	Turn(lthigh, z_axis, 0.016547, 1.240995 * speedMult)
	Turn(rcalf, x_axis, 0.141798, 111.707680 * speedMult)
	Turn(rfoot, x_axis, -0.053054, 85.365942 * speedMult)
	Turn(rthigh, x_axis, -0.088743, 108.067301 * speedMult)
end

function script.StartMoving()
	if not walking then
		walking = true
		if GG.lodLevelMedium then
			StartThread(WalkLowDetail)
		else
			StartThread(Walk)
		end
	end
end

function script.StopMoving()
	walking = false
	StartThread(StopWalking)
end

function script.Create()
	StartThread(GG.Script.SmokeUnit, unitID, smokePiece)
	--StartThread(SpinScienceThread)
end

-----------------------------
-- Weapon

function script.AimFromWeapon()
	return pelvis
end

function script.QueryWeapon()
	return pelvis
end

local function RestoreAfterDelay()
	Signal(SIG_RESTORE)
	SetSignalMask(SIG_RESTORE)
	Sleep(1000)
	Turn(aimyaw, y_axis, 0, math.rad(135))
	Turn(aimpitch, x_axis, 0, math.rad(85))
end

function script.AimWeapon(num, heading, pitch)
	StartThread(RestoreAfterDelay)
	Signal(SIG_AIM)
	SetSignalMask(SIG_AIM)
	Turn(aimyaw, y_axis, heading, math.rad(360)) -- left-right
	Turn(aimpitch, x_axis, -pitch, math.rad(270)) --up-down
	WaitForTurn(aimyaw, y_axis)
	WaitForTurn(aimpitch, x_axis)
	return true
end

function script.FireWeapon(num)
	Turn(pole, x_axis, math.rad(90), math.rad(40000))
	Turn(box, x_axis, math.rad(-50), math.rad(40000))
	Move(box, y_axis, 15, 300)
	Sleep(30)
	Turn(pole, x_axis, 0, math.rad(80))
	Turn(box, x_axis, 0, math.rad(40))
	Move(box, y_axis, 0, 10)
end


-----------------------------
-- Death

function Detonate() -- Giving an order causes recursion.
	GG.QueueUnitDescruction(unitID)
end

function script.Killed(recentDamage, maxHealth)
	Explode(box, SFX.SHATTER + SFX.SMOKE)
	
	local severity = recentDamage / maxHealth
	if (severity <= 0.5) then
		return 1 -- corpsetype
	else
		return 2 -- corpsetype
	end
end
